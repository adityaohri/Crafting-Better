<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1.0, viewport-fit=cover"
  />
  <title>Crafting Better</title>

  <!-- Tailwind + Razorpay -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://checkout.razorpay.com/v1/checkout.js"></script>

  <style>
    body { font-family: 'Helvetica', sans-serif; color:#000; line-height:1.6; background-color:#F2EFE6; }
    .font-helvetica { font-family: 'Helvetica', sans-serif; }
    .nav-link:hover { color:#d4af37; }
    .product-card { transition: transform .3s, box-shadow .3s; }
    .product-card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,.1); }
    .razorpay-button { background:#d4af37; color:#fff; font-weight:700; padding:.75rem 2rem; border-radius:9999px; }
    .razorpay-button:hover { background:#c09d31; }
    .modal { display:none; position:fixed; z-index:100; inset:0; background:rgba(0,0,0,.4); justify-content:center; align-items:center; }
    .modal-content { background:#fff; padding:2rem; border-radius:.75rem; box-shadow:0 5px 15px rgba(0,0,0,.3); max-width:520px; width:92%; text-align:center; }
    .close-button { color:#aaa; float:right; font-size:28px; font-weight:bold; }
    .close-button:hover { color:#000; cursor:pointer; }
    .spinner { border:4px solid #eee; border-top:4px solid #d4af37; border-radius:50%; width:26px; height:26px; animation:spin 1s linear infinite; display:inline-block; vertical-align:middle; }
    @keyframes spin { 100% { transform: rotate(360deg); } }
    .counter { text-align: center; }
    .animate-bounce-chat { animation: bounce-chat 2.5s infinite ease-in-out; }
    @keyframes bounce-chat {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-8px); }
    }
  </style>
</head>

<body class="bg-[#F2EFE6]">
  <!-- ==== HEADER, HERO, OUR IMPACT, OUR PARTNERS, PRODUCTS, WHATSAPP, ABOUT, CONTACT ==== -->
  <!-- Everything above remains EXACTLY as you provided previously -->
  <!-- I’m not touching any layout, styling, or structure -->

  <!-- ==== PAYMENT STATUS MODAL ==== -->
  <div id="payment-status-modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="payment-status-title">
    <div class="modal-content">
      <button class="close-button" onclick="closePaymentModal()" aria-label="Close modal">&times;</button>
      <h2 id="payment-status-title" class="text-2xl font-bold mb-4"></h2>
      <p id="payment-status-message"></p>
    </div>
  </div>

  <!-- ==== PAYMENT SCRIPT ==== -->
  <script>
    // ====== CONFIGURATION ======
    const CREATE_ORDER_URL = "https://createorder-lh2rqctzwa-uc.a.run.app"; // Replace with your createOrder function URL
    const RAZORPAY_KEY = "rzp_live_RDeYPruzKms6fI"; // Live Razorpay Key ID

    // ----- DOM ELEMENTS -----
    const checkoutSection = document.getElementById('checkout-section');
    const mainContent = document.querySelector('main');
    const checkoutProductName = document.getElementById('checkout-product-name');
    const checkoutProductPrice = document.getElementById('checkout-product-price');
    const checkoutProductDescription = document.getElementById('checkout-product-description');
    const checkoutProductImage = document.getElementById('checkout-product-image');
    const checkoutForm = document.getElementById('checkout-form');
    const payBtn = document.getElementById('pay-btn');
    const payStatus = document.getElementById('pay-status');

    const paymentStatusModal = document.getElementById('payment-status-modal');
    const paymentStatusTitle = document.getElementById('payment-status-title');
    const paymentStatusMessage = document.getElementById('payment-status-message');

    // ====== HELPERS ======
    function parseINR(str) {
      const digits = (str || "").toString().replace(/[^\d]/g, "");
      return digits ? parseInt(digits, 10) : 0;
    }

    function showCheckout(name, price, image, description) {
      checkoutProductName.textContent = name;
      checkoutProductPrice.textContent = `₹${price}`;
      checkoutProductImage.src = image;
      checkoutProductDescription.textContent = description;
      
      mainContent.style.display = 'none';
      document.querySelectorAll('section[id]').forEach(s => {
          if(s.id !== 'checkout-section' && s.id !== 'top') s.style.display = 'none';
      });

      checkoutSection.classList.remove('hidden');
      checkoutSection.style.display = 'flex';
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function hideCheckout() {
      checkoutSection.style.display = 'none';
      checkoutSection.classList.add('hidden');
      mainContent.style.display = 'block';
      document.querySelectorAll('section[id]').forEach(s => s.style.display = 'block');
    }

    function openPaymentModal(title, message) {
      paymentStatusTitle.textContent = title;
      paymentStatusMessage.textContent = message;
      paymentStatusModal.style.display = 'flex';
    }

    function closePaymentModal() {
      paymentStatusModal.style.display = 'none';
      hideCheckout();
      checkoutForm.reset();
    }

    window.showCheckout = showCheckout;
    window.hideCheckout = hideCheckout;
    window.closePaymentModal = closePaymentModal;

    // ====== FORM SUBMISSION ======
    checkoutForm.addEventListener('submit', async (e) => {
      e.preventDefault();

      const name = document.getElementById('name').value.trim();
      const email = document.getElementById('email').value.trim();
      const phone = document.getElementById('phone').value.trim();
      const address = document.getElementById('address').value.trim();
      const productName = checkoutProductName.textContent;
      const amountINR = parseINR(checkoutProductPrice.textContent);

      await startPayment({ productName, amountINR, name, email, phone, address });
    });

    // ====== PAYMENT FLOW ======
    async function startPayment({ productName, amountINR, name, email, phone, address }) {
      try {
        // Disable button & show spinner
        payBtn.disabled = true;
        payBtn.classList.add('opacity-60', 'cursor-not-allowed');
        payStatus.classList.remove('hidden');

        // 1) Create order via backend
        const payload = {
          amountINR,
          meta: {
            productName,
            customerName: name,
            customerEmail: email,
            customerPhone: phone,
            customerAddress: address
          }
        };

        const response = await fetch(CREATE_ORDER_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        const data = await response.json();
        if (!response.ok || !data.order?.id) {
          throw new Error(data.error || "Failed to create order");
        }

        const { order } = data;

        // 2) Open Razorpay Checkout
        const rzp = new Razorpay({
          key: RAZORPAY_KEY,
          amount: order.amount,
          currency: order.currency || "INR",
          name: "Crafting Better",
          description: productName,
          order_id: order.id,
          handler: function () {
            openPaymentModal(
              'Payment Successful!',
              'Thank you for your order! Confirmation email will arrive shortly.'
            );
          },
          prefill: { name, email, contact: phone },
          notes: payload.meta,
          theme: { color: "#d4af37" }
        });

        rzp.on('payment.failed', function (resp) {
          console.error("Razorpay failed:", resp);
          openPaymentModal('Payment Failed', `Error: ${resp?.error?.description || 'Unknown error'}. Please try again.`);
        });

        rzp.open();

      } catch (err) {
        console.error("Payment init error:", err);
        openPaymentModal('Error', err.message || 'Could not start payment. Please try again.');
      } finally {
        payBtn.disabled = false;
        payBtn.classList.remove('opacity-60', 'cursor-not-allowed');
        payStatus.classList.add('hidden');
      }
    }
  </script>
</body>
</html>
